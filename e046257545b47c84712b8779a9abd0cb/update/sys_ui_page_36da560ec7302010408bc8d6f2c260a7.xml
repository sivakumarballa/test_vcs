<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ui_page">
    <sys_ui_page action="INSERT_OR_UPDATE">
        <category>general</category>
        <client_script><![CDATA[// Constants
var SPOKE_INSTALLED_CHECK_TYPES = ['SPOKE_INSTALLED', 'TEMPLATE_SPOKE_INSTALLED'];
var SPOKE_CONFIGURED_CHECK_TYPES = ['CONNECTION_CONFIGURED'];
var INSTALL_SPOKE_URL = 'https://store.servicenow.com/sn_appstore_store.do#!/store/search?q=<scope_name>';
var CONFIGURE_SPOKE_URL = '/$flow-designer.do?sysparm_nostack=true#/welcome/connection-dashboard/<alias_id>';
var UNINSTALLED_STATUS = 'UNINSTALLED';
var NOT_CONFIGURED_STATUS = 'NOT_CONFIGURED';
var INSTALLED_CONFIGURED_STATUS = 'INSTALLED_CONFIGURED';
var STATUS_MAPPING = {};
STATUS_MAPPING[UNINSTALLED_STATUS] = gel('uninstalled').value;
STATUS_MAPPING[NOT_CONFIGURED_STATUS] = gel('needsConfig').value;
STATUS_MAPPING[INSTALLED_CONFIGURED_STATUS] = gel('installed').value;

// Get templates
var xhr = getTemplatesRequest(new XMLHttpRequest());
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
		try {
			var templates =  JSON.parse(xhr.responseText);
			var spokes = extractSpokes(templates.result);
			setSpokesInTable(spokes); // inject the spokes into the HTML
		} catch (e) {
			console.error('Error parsing templates response', e);
		}
	}
};

function getTemplatesRequest(xhr) {
	xhr.open('GET', '/api/now/templates', true);
	xhr.setRequestHeader("X-UserToken", window.g_ck);
	xhr.send(null);
	return xhr;
}

function extractSpokes(templates) {
	var spokes = {};
	var spokesStatuses = SPOKE_INSTALLED_CHECK_TYPES.concat(SPOKE_CONFIGURED_CHECK_TYPES);

    if (templates.length === 0) {
		return spokes;
	}

	templates.forEach(function (template) {
		var dependenciesResult = template.dependency_evaluation_results || [];

		var dependenciesSpokesResults = dependenciesResult.filter(function(result) {
			var dependency = result.dependency || {};
			var inputs = dependency.inputs || {};
			return spokesStatuses.includes(result.type) && inputs.hasOwnProperty('scope_name');
		});

		dependenciesSpokesResults.forEach(function(result) {
			var dependencyScope = result.dependency.inputs.scope_name;
			var existingSpokeObject = spokes[dependencyScope] || {};
			spokes[dependencyScope] = Object.assign(existingSpokeObject, {
				name: result.dependency.inputs.spoke_name || dependencyScope,
				scopeName: dependencyScope,
				id: dependencyScope
			});

			setSpokeStatusAndLink(spokes[dependencyScope], result);
		});
	});
	
	return spokes;
}

function setSpokeStatusAndLink(currentSpoke, result) {
	if (currentSpoke.status === UNINSTALLED_STATUS) { // It is uninstalled. This trumps all other checks
		return;
	}
	if (SPOKE_INSTALLED_CHECK_TYPES.includes(result.type) && result.checkFailed) {
		currentSpoke.status = UNINSTALLED_STATUS;
		currentSpoke.link = INSTALL_SPOKE_URL.replace('<scope_name>', result.dependency.inputs.scope_name);
		return;
	}
	if (currentSpoke.status === NOT_CONFIGURED_STATUS) { // It is not configured. This trumps other checks below
		return;
	}
	if (SPOKE_CONFIGURED_CHECK_TYPES.includes(result.type) && result.checkFailed) {
		currentSpoke.status = NOT_CONFIGURED_STATUS;
		currentSpoke.link = CONFIGURE_SPOKE_URL.replace('<alias_id>', result.dependency.inputs.alias_id);
		return;
	}
	currentSpoke.status = INSTALLED_CONFIGURED_STATUS;
	currentSpoke.link = null;
}

function setSpokesInTable(spokes) {
	var html = '';
	Object.keys(spokes).map(function(key) {
		html = html + '<tr>' + getSpokeNameCell(spokes[key]) + getSpokeStatusCell(spokes[key]) +'</tr>';
	});
	
	var tBodyNode = document.getElementById('insert-spokes-here');
	tBodyNode.insertAdjacentHTML('afterbegin', html);
}

function getSpokeNameCell(spoke) {
	if (spoke.link) {
		return '<td><a href="' + spoke.link + '" target="_blank" class="spokeName">' + spoke.name + '</a></td>';
	}
	return '<td class="spokeName">' + spoke.name + '</td>';
}

function getSpokeStatusCell(spoke) {
	return '<td>' + STATUS_MAPPING[spoke.status] + '</td>';
}]]></client_script>
        <description/>
        <direct>false</direct>
        <endpoint>sn_app_eng_studio_spokes_configuration.do</endpoint>
        <html><![CDATA[<?xml version="1.0" encoding="utf-8" ?>
<j:jelly trim="false" xmlns:j="jelly:core" xmlns:g="glide" xmlns:j2="null" xmlns:g2="null">
	<style>
		.spokes_configuration {
			padding: 0 48px;
			font-family: SourceSansPro;
		}

		td,
		th {
			font-size: 16px;
			border: 1px solid #9AA4A5;
			padding: 12px;
		}
		
		td {
			color: #161B1C;
		}
		
		.spokeName {
			font-size: 16px;
			color: #01596B;
			text-decoration: none;
		}
		
		.table__head {
			border-bottom: 2px solid #D1D6D6;
		}
		
		.table__th {
			color: #637274;
		}
		
		.hd1 {
			font-size: 14px;
			font-weight: bold;
			padding-bottom: 15px;
		}
	</style>
	<g:evaluate>
		var translatedHeading = gs.getMessage('All spokes must be configured and installed in order to work in App Engine Studio');
		var translatedSpokeHeader = gs.getMessage('Spoke');
		var translatedStatusHeader = gs.getMessage('Status');
		var translatedUninstalled = gs.getMessage('Uninstalled');
		var translatedNeedsConfiguration = gs.getMessage('Needs Configuration');
		var translatedInstalledConfigured = gs.getMessage('Installed and configured');
	</g:evaluate>
	<div class="spokes_configuration">
		<h1 class="hd1">${translatedHeading}</h1>
		
		<input id="uninstalled" type="hidden" disabled="true" value="$[translatedUninstalled]"/>
		<input id="needsConfig" type="hidden" disabled="true" value="$[translatedNeedsConfiguration]"/>
		<input id="installed" type="hidden" disabled="true" value="$[translatedInstalledConfigured]"/>
		
		<table style="min-width: 500px">
			<thead class="table__head">
				<tr>
					<th class="table__th">${translatedSpokeHeader}</th>
					<th class="table__th">${translatedStatusHeader}</th>
				</tr>
			</thead>
			<tbody id="insert-spokes-here"></tbody>
		</table>
	</div>
</j:jelly>]]></html>
        <name>spokes_configuration</name>
        <processing_script/>
        <sys_class_name>sys_ui_page</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2020-12-02 02:32:30</sys_created_on>
        <sys_id>36da560ec7302010408bc8d6f2c260a7</sys_id>
        <sys_mod_count>57</sys_mod_count>
        <sys_name>spokes_configuration</sys_name>
        <sys_package display_value="App Engine Studio" source="sn_app_eng_studio">e046257545b47c84712b8779a9abd0cb</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="App Engine Studio">e046257545b47c84712b8779a9abd0cb</sys_scope>
        <sys_update_name>sys_ui_page_36da560ec7302010408bc8d6f2c260a7</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2020-12-11 18:04:52</sys_updated_on>
    </sys_ui_page>
</record_update>
