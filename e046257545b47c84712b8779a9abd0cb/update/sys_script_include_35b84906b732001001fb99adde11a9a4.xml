<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>sn_app_eng_studio.ImageAttachmentValidator</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Validates the type/file extension (based on the sn_app_eng_studio.illustration_supported_content_types system property) of the attachments added to Taxonomy and Taxonomy Category records.</description>
        <name>ImageAttachmentValidator</name>
        <script><![CDATA[var ImageAttachmentValidator = Class.create();
ImageAttachmentValidator.prototype = {

    initialize: function(currentRecord, imageField, supportedTypes) {
		this.currentRecord = currentRecord;
		this.imageField = imageField;
		this.supportedTypes = supportedTypes;
    },
	
	validate: function() {
		var imageFieldValue = this.currentRecord.getValue(this.imageField);
		var table = "ZZ_YY" + this.currentRecord.getRecordClassName();
		var attachment = new GlideRecord("sys_attachment");

		if (!gs.nil(imageFieldValue))
			attachment.get(imageFieldValue);

		if (attachment.isValidRecord()) {
			if (!this.validateAttachment(attachment)) {
				this.currentRecord.setAbortAction(true);
				this.currentRecord.setValue(this.imageField, "NULL");
				return this.currentRecord;
			}
		}
			
		
		else {
			attachment.initialize();
			attachment.addQuery("table_name", table);
			attachment.addQuery("table_sys_id", this.currentRecord.getUniqueValue());
			attachment.addQuery("file_name", this.imageField);
			attachment.query();
			
			while (attachment.next()) {
				if (!this.validateAttachment(attachment)) {
					this.currentRecord.setAbortAction(true);
					this.currentRecord.setValue(this.imageField, "NULL");
					return this.currentRecord;
				}
			}
		}
		
		return this.currentRecord;
	},

	validateAttachment: function(attachment) {
		var contentTypeValidator = new global.ContentTypeValidator();
		if (!contentTypeValidator.isValidType(attachment, this.supportedTypes)) {
			
			// set the abort action & error message
			var errorMessage = gs.getMessage("The {0} must be one of the following content types: {1}", [this.imageField, this.supportedTypes.join(", ")]);
			gs.addErrorMessage(errorMessage);
			
			// then try to delete the attachment
			try {
				var gsa = new GlideSysAttachment();
				gsa.deleteAttachment(attachment.getUniqueValue());
			} catch (error) {
				gs.error("Unable to delete invalid attachment ({0})", attachment.getUniqueValue());
			}

			return false;
		}
		return true;
	},
	
	attachmentExists: function(tableRecordSysId, fileNameTableColumn) {
		var attachment = new GlideRecord("sys_attachment");
		attachment.addQuery("table_sys_id", tableRecordSysId);
		attachment.addQuery("file_name", fileNameTableColumn);
		attachment.query();
		return attachment.hasNext();
	},

    type: 'ImageAttachmentValidator'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2020-02-07 14:23:05</sys_created_on>
        <sys_id>35b84906b732001001fb99adde11a9a4</sys_id>
        <sys_mod_count>15</sys_mod_count>
        <sys_name>ImageAttachmentValidator</sys_name>
        <sys_package display_value="App Engine Studio" source="sn_app_eng_studio">e046257545b47c84712b8779a9abd0cb</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="App Engine Studio">e046257545b47c84712b8779a9abd0cb</sys_scope>
        <sys_update_name>sys_script_include_35b84906b732001001fb99adde11a9a4</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2020-03-10 16:32:56</sys_updated_on>
    </sys_script_include>
</record_update>
